name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  claude-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Run Claude Code Review
        id: claude-review
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.pull_request.number }}

            Please review this pull request for a tower defense game (React + Phaser 3 + TypeScript) and provide feedback on:
            - Code quality and best practices
            - Potential bugs or issues
            - Performance implications
            - Security vulnerabilities
            - Test coverage

            Be constructive and helpful. Use `gh pr comment` to leave your review as a comment on the PR.

          claude_args: '--allowed-tools "Bash(gh issue view:*),Bash(gh search:*),Bash(gh issue list:*),Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*),Bash(gh pr list:*)"'

      - name: Create issue on review failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request?.number;
            const branch = context.ref.replace('refs/heads/', '').replace('refs/pull/', 'PR #').replace('/merge', '');
            const sha = context.sha.substring(0, 7);

            const title = 'ğŸ”´ Claude Code Review Failed - PR #' + (prNumber || 'N/A');
            const body = '## Claude Code Review å¤±è´¥\n\n' +
              '**åˆ†æ”¯:** ' + branch + '\n' +
              '**æäº¤:** ' + sha + '\n' +
              '**Workflow:** Claude Code Review\n\n' +
              '### ğŸ” æŸ¥çœ‹è¯¦æƒ…\n\n' +
              '**Workflowè¿è¡Œæ—¥å¿—:** https://github.com/' + context.repo.owner + '/' + context.repo.repo + '/actions/runs/' + context.runId + '\n\n' +
              '### ğŸ› ï¸ å¯èƒ½çš„åŸå› \n\n' +
              '- **ç¼ºå°‘ ANTHROPIC_API_KEY**: Secretæœªé…ç½®æˆ–å·²è¿‡æœŸ\n' +
              '- **APIè°ƒç”¨å¤±è´¥**: APIé¢åº¦ä¸è¶³æˆ–æœåŠ¡ä¸å¯ç”¨\n' +
              '- **æƒé™é—®é¢˜**: Workflowæƒé™é…ç½®ä¸æ­£ç¡®\n\n' +
              '### âœ… ä¿®å¤æ­¥éª¤\n\n' +
              '1. **æ£€æŸ¥API Keyé…ç½®**:\n' +
              '   - å‰å¾€ Settings â†’ Secrets and variables â†’ Actions\n' +
              '   - ç¡®è®¤ `ANTHROPIC_API_KEY` å·²é…ç½®ä¸”æœ‰æ•ˆ\n\n' +
              '2. **éªŒè¯API Key**:\n' +
              '   - æµ‹è¯•API Keyæ˜¯å¦å¯ç”¨\n' +
              '   - æ£€æŸ¥APIé¢åº¦æ˜¯å¦å……è¶³\n\n' +
              '3. **æŸ¥çœ‹è¯¦ç»†æ—¥å¿—**:\n' +
              '   - ç‚¹å‡»ä¸Šé¢çš„workflowæ—¥å¿—é“¾æ¥\n' +
              '   - æŸ¥çœ‹å…·ä½“çš„é”™è¯¯ä¿¡æ¯\n\n' +
              '### ğŸ’¡ ä¸´æ—¶è§£å†³æ–¹æ¡ˆ\n\n' +
              'å¦‚æœä¸éœ€è¦è‡ªåŠ¨Code Review:\n' +
              '- åˆ é™¤æˆ–ç¦ç”¨ `.github/workflows/claude-review.yml`\n' +
              '- æˆ–åªåœ¨ç‰¹å®šæ¡ä»¶ä¸‹è§¦å‘ï¼ˆå¦‚å¤–éƒ¨è´¡çŒ®è€…ï¼‰\n\n' +
              '---\n\n' +
              '*ç”± Claude Code Review workflow è‡ªåŠ¨ç”Ÿæˆ*';

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['bug', 'ci', 'code-review', 'auto-generated']
            });
