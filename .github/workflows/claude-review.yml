name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  claude-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Run Claude Code Review
        id: claude-review
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.pull_request.number }}

            Please review this pull request for a tower defense game (React + Phaser 3 + TypeScript) and provide feedback on:
            - Code quality and best practices
            - Potential bugs or issues
            - Performance implications
            - Security vulnerabilities
            - Test coverage

            Be constructive and helpful. Use `gh pr comment` to leave your review as a comment on the PR.

          claude_args: '--allowed-tools "Bash(gh issue view:*),Bash(gh search:*),Bash(gh issue list:*),Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*),Bash(gh pr list:*)"'

      - name: Create issue on review failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request?.number;
            const branch = context.ref.replace('refs/heads/', '').replace('refs/pull/', 'PR #').replace('/merge', '');
            const sha = context.sha.substring(0, 7);

            const title = '🔴 Claude Code Review Failed - PR #' + (prNumber || 'N/A');
            const body = '## Claude Code Review 失败\n\n' +
              '**分支:** ' + branch + '\n' +
              '**提交:** ' + sha + '\n' +
              '**Workflow:** Claude Code Review\n\n' +
              '### 🔍 查看详情\n\n' +
              '**Workflow运行日志:** https://github.com/' + context.repo.owner + '/' + context.repo.repo + '/actions/runs/' + context.runId + '\n\n' +
              '### 🛠️ 可能的原因\n\n' +
              '- **缺少 ANTHROPIC_API_KEY**: Secret未配置或已过期\n' +
              '- **API调用失败**: API额度不足或服务不可用\n' +
              '- **权限问题**: Workflow权限配置不正确\n\n' +
              '### ✅ 修复步骤\n\n' +
              '1. **检查API Key配置**:\n' +
              '   - 前往 Settings → Secrets and variables → Actions\n' +
              '   - 确认 `ANTHROPIC_API_KEY` 已配置且有效\n\n' +
              '2. **验证API Key**:\n' +
              '   - 测试API Key是否可用\n' +
              '   - 检查API额度是否充足\n\n' +
              '3. **查看详细日志**:\n' +
              '   - 点击上面的workflow日志链接\n' +
              '   - 查看具体的错误信息\n\n' +
              '### 💡 临时解决方案\n\n' +
              '如果不需要自动Code Review:\n' +
              '- 删除或禁用 `.github/workflows/claude-review.yml`\n' +
              '- 或只在特定条件下触发（如外部贡献者）\n\n' +
              '---\n\n' +
              '*由 Claude Code Review workflow 自动生成*';

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['bug', 'ci', 'code-review', 'auto-generated']
            });
