name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  claude-review:
    name: AI Code Review
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR diff
        id: diff
        run: |
          git fetch origin ${{ github.base_ref }}
          DIFF=$(git diff origin/${{ github.base_ref }}...HEAD)
          echo "diff<<EOF" >> $GITHUB_OUTPUT
          echo "$DIFF" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Review with Claude API
        uses: actions/github-script@v7
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        with:
          script: |
            const pullNumber = context.payload.pull_request?.number;
            if (!pullNumber) {
              console.log('No pull request found in context');
              return;
            }

            const diff = `${{ steps.diff.outputs.diff }}`;

            // Call Claude API for code review
            const response = await fetch('https://api.anthropic.com/v1/messages', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'x-api-key': process.env.ANTHROPIC_API_KEY,
                'anthropic-version': '2023-06-01'
              },
              body: JSON.stringify({
                model: 'claude-sonnet-4-20250514',
                max_tokens: 4096,
                messages: [{
                  role: 'user',
                  content: `Please review this code diff and provide feedback on:
                  1. Code quality and best practices
                  2. Potential bugs or issues
                  3. Performance concerns
                  4. Security vulnerabilities
                  5. Suggestions for improvement

                  Focus on the tower defense game context (React + Phaser 3 + TypeScript).

                  Diff:
                  \`\`\`diff
                  ${diff}
                  \`\`\`

                  Format your response in markdown with clear sections.`
                }]
              })
            });

            const data = await response.json();
            const review = data.content[0].text;

            // Post review as comment
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pullNumber,
              body: `## ü§ñ Claude AI Code Review\n\n${review}\n\n---\n*This review was automatically generated by Claude API*`
            });

      - name: Handle API errors
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const pullNumber = context.payload.pull_request?.number;
            if (pullNumber) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pullNumber,
                body: '‚ö†Ô∏è Claude AI code review failed. Please ensure ANTHROPIC_API_KEY is configured in repository secrets.'
              });
            }
